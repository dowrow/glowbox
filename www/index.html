
<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>
            AudioTest
        </title>
        
        <style>
            #canvas {
                position: relative;
                top: 100px;
                left:50%;
                margin-left: -480px;
            }
        </style>

    </head>
    <body>

        <button id="play">PLAY ►</button>
        <button id="stop">STOP ■</button>
        <canvas id="canvas" width="960" height="520" style="background-color:black">
        </canvas>

        <script src="howler.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.10.1.min.js"><\/script>')</script>

        <script>
            var DEBUG = true;
            console = DEBUG ? console : {};


            var Loopy = (function ($) {
                
                // Private model
                var soundMatrix = new Array(5),
                    samples = new Array(5),
                    canvas,
                    ctx,
                    playInterval = -1,
                    bmp = 180,
                    timeout = Math.round((60000 / bmp) / 4),
                    index = 0;

                function _bindCanvas(id) {
                    ctx = $('#' + id)[0].getContext('2d');
                    setInterval (_render, 15);
                    console.log("Canvas bind");
                    for (var i = 0; i < 5; i++) {
                        soundMatrix[i] = new Array(16);
                        for (var j = 0; j < 16; j++) {
                            soundMatrix[i][j] = false;
                        }
                    }

                    soundMatrix = 
                        [[true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false],
                        [false, false, false, false, true, false, false, false, false, false, false, false, true, false, false, false],
                        [true, false, false, false, false, false, false, false, false, false, true, false, false, false, false, false],
                        [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false],
                        [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false],
                        [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false],
                        [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false],
                        [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false]];

                    $('#' + id).click(_changeSquare);

                    samples[0] = new Howl({ urls: ['/samples/hihat.mp3']});
                    samples[1] = new Howl({ urls: ['/samples/snare.mp3']});
                    samples[2] = new Howl({ urls: ['/samples/bassdrum.mp3']});
                    samples[3] = new Howl({ urls: ['/samples/hihat.mp3']});
                    samples[4] = new Howl({ urls: ['/samples/hihat.mp3']});
                }

                function _bindPlay (id) {
                    $('#' + id).click(_play);

                }

                function _bindStop (id) {
                    $('#' + id).click(_stop);

                }

                function _playColumn () {
                    index = (index + 1) % 16;
                    for (var i = 0; i < 5; i++)
                        if (soundMatrix[i][index])
                            samples[i].play();
                }

                function _play() {
                    if (playInterval == -1)
                        playInterval = setInterval(_playColumn, timeout);
                }

                function _stop() {
                    clearInterval(playInterval);   
                    playInterval = -1
                }

                function _render () {
                    var wStep = 960 / 16,
                        hStep = 520 / 5;
                    for (var i = 0; i < 5; i++) {
                        for (var j = 0; j < 16; j++) {
                            
                            // Si es bloque música y j == index -> Random
                            // Si es bloque música y j =! index -> Blanco
                            // Si j == index
                            // Si no, negro
                            if (soundMatrix[i][j] && (j == index))
                                ctx.fillStyle = '#' + Math.floor(Math.random * 16777215).toString(16);
                            else if (soundMatrix[i][j] && (j!=index))
                               ctx.fillStyle = '#FFFFFF';
                            else if (j == index && playInterval != -1)
                                ctx.fillStyle = '#222222';
                            else
                                ctx.fillStyle = '#000000';

                            ctx.fillRect(j* wStep, i * hStep, wStep, hStep);
                        }
                    }

                }

                function _setBmp (newBmp) {
                    _stop();

                    bmp = newBmp;
                    timeout = Math.round(60000 / bmp);
                    
                    _play();

                }

                function _changeSquare (e) {
                    
                    var x = e.originalEvent.offsetX,
                        y = e.originalEvent.offsetY,
                        wStep = 960 / 16,
                        hStep = 520 / 5,
                        squareX = (x - (x % wStep)) / wStep,
                        squareY = (y - (y % hStep)) / hStep;

                    soundMatrix[squareY][squareX] = !soundMatrix[squareY][squareX];
                }

                // Public API
                return {
                    bindCanvas: _bindCanvas,
                    bindPlay: _bindPlay,
                    bindStop: _bindStop,
                    play: _play,
                    stop: _stop,
                    changeSquare: _changeSquare,
                    setBmp: _setBmp,
                };  

            })($ || jQuery);

            Loopy.bindCanvas('canvas');
            Loopy.bindPlay('play');
            Loopy.bindStop('stop');
            Loopy.play();

        </script>

        <script>
            var _gaq=[['_setAccount','UA-XXXXX-X'],['_trackPageview']];
            (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
            g.src='//www.google-analytics.com/ga.js';
            s.parentNode.insertBefore(g,s)}(document,'script'));
        </script>
    </body>
</html>